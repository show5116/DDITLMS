<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{layout/layout}">
<th:block layout:fragment="content">
    <th:block th:replace="/fragment/page-header.html :: page-headerFragment(title='등록 관리')"></th:block>
    <div class="container-fluid">
        <div class="col-lg-12">
            <div class="card">
                <div class="p-20">
                    <div id="not-regist-students" class="tab-content m-t-5">
                        <div class="row justify-content-between b-l-secondary border-6 m-b-15 ">
                            <div class="col align-self-center">
                                <h4 style="display: inline-block;" class="f-w-700 p-l-10 m-b-0 m-t-5">등록 관리</h4>
                                <span class="text-muted p-l-10 m-t-10" th:text="${#lists.size(studentList)+'건'}"></span>
                            </div>
                        </div>
                        <div class="row m-b-10 m-t-20" style="height: 39px">
                            <div class="row col-sm-1 p-r-0 p-l-20">
                                <i class="col-sm-3 fa fa-search align-self-center"></i>
                                <select id="student-search-category" class="col-sm form-select">
                                    <option value="name">이름</option>
                                    <option value="number">학번</option>
                                </select>
                            </div>
                            <div class="row col-sm-4 m-l-5">
                                <input onkeyup="searchStudent()" id="student-serch-box" style="display:inline-block; width:50%;" class="form-control" placeholder="학생 검색">
                            </div>
                        </div>
                        <div class="table-responsive" style="height: 839px; overflow-y: auto;">
                            <table class="table table-hover text-center b-light">
                                <thead class="table-secondary">
                                <tr class="f-w-300">
                                    <th class="f-16">학번</th>
                                    <th class="f-16">이름</th>
                                    <th class="f-16">학과</th>
                                    <th class="f-16">등록금</th>
                                    <th class="f-16">실납부액</th>
                                    <th class="f-16">완납</th>
                                    <th class="f-16">미납</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="student : ${studentList}">
                                    <td class="student-number" th:text="${student.getUserNumber()}"></td>
                                    <td class="student-name" th:text="${student.getName()}"></td>
                                    <td th:text="${student.getMajor()}"></td>
                                    <td th:text="${student.getPayment()}"></td>
                                    <td th:text="${student.getRealPayment()}"></td>
                                    <td><button class="btn-primary btn-sm" type="button" onclick="completePay()">완납</button></td>
                                    <td><button class="btn-primary btn-sm" type="button" onclick="notPay()">미납</button></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function searchStudent(){
            const searchBox = document.querySelector("#student-serch-box");
            const searchCategory = document.querySelector("#student-search-category");
            if(event.keyCode != 13 || (searchCategory.value == "number" && isNaN(searchBox.value))){
                return;
            }
            const params = {
                category : searchCategory.value,
                search : searchBox.value
            };
            $.ajax({
                url: "/studentDep/register/search",
                data: params,
                method: "POST",
                beforeSend: function(xhr){
                    xhr.setRequestHeader(header,token);
                }
            })
            .done((fragment)=>{
                $("#not-regist-students").replaceWith(fragment);
            });
        }

        function completePay(){
            const parent = event.target.parentNode.parentNode;
            const number = parent.querySelector(".student-number");
            const name = parent.querySelector(".student-name");
            swal({
                text : `${number.innerText} ${name.innerText} 학생이 납부하였습니까?`,
                icon: "warning",
                buttons : true,
                dangerMode : true
            })
            .then((ok)=>{
                if(ok){
                    const params = {
                        id : number.innerText
                    };
                    $.ajax({
                        url: "/studentDep/register/completePay",
                        data: params,
                        method: "POST",
                        beforeSend: function(xhr){
                            xhr.setRequestHeader(header,token);
                        }
                    })
                    .done((fragment)=>{
                        $("#not-regist-students").replaceWith(fragment);
                        swal("처리되었습니다.",{
                            icon : "success"
                        })
                    });
                } else{
                    swal("취소되었습니다.");
                }
            });
        }
        function notPay(){
            const parent = event.target.parentNode.parentNode;
            const number = parent.querySelector(".student-number");
            const name = parent.querySelector(".student-name");
            swal({
                text : `${number.innerText} ${name.innerText} 학생이 미납하였습니까?`,
                icon: "warning",
                buttons : true,
                dangerMode : true
            })
            .then((ok)=>{
                if(ok){
                    const params = {
                        id : number.innerText
                    };
                    $.ajax({
                        url: "/studentDep/register/notPay",
                        data: params,
                        method: "POST",
                        beforeSend: function(xhr){
                            xhr.setRequestHeader(header,token);
                        }
                    })
                    .done((fragment)=>{
                        $("#not-regist-students").replaceWith(fragment);
                        swal("처리되었습니다.",{
                            icon : "success"
                        })
                    });
                } else{
                    swal("취소되었습니다.");
                }
            });
        }
    </script>
</th:block>